<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>東京夜景</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
html, body { width:100%; height:100%; overflow:hidden; background:#000; }
canvas { position:fixed; top:0; left:0; }
</style>
</head>
<body>

<!-- DEMO_META
title: TOKYO NIGHT
desc: 東京の夜景をCanvas 2Dで描画。4レイヤー構成、雨エフェクト、ネオンサイン
tech: Procedural Generation · Layered Rendering · Rain Physics
level: 87
color: #ec4899
type: demo
-->

<canvas id="c"></canvas>
<script>
(function() {
var canvas = document.getElementById('c');
var ctx = canvas.getContext('2d');
var W = 800, H = 600, T = 0;

function resize() {
  W = canvas.width  = window.innerWidth  || 800;
  H = canvas.height = window.innerHeight || 600;
  initScene();
}
window.addEventListener('resize', resize);

function rnd(a,b)    { return a + Math.random()*(b-a); }
function rndI(a,b)   { return Math.floor(rnd(a,b)); }
function lerp(a,b,t) { return a+(b-a)*t; }
function clamp(v,a,b){ return v<a?a:v>b?b:v; }

// ── BUILDINGS ──
var buildings = [];
var LAYERS = [
  { z:0, alpha:0.55, hScale:0.38, yBase:0.72, winAlpha:0.5,  fogAlpha:0.0  },
  { z:1, alpha:0.72, hScale:0.52, yBase:0.78, winAlpha:0.65, fogAlpha:0.0  },
  { z:2, alpha:0.88, hScale:0.68, yBase:0.84, winAlpha:0.82, fogAlpha:0.0  },
  { z:3, alpha:1.0,  hScale:0.45, yBase:0.90, winAlpha:1.0,  fogAlpha:0.0  },
];

function makeBuilding(layer, x) {
  var lp = LAYERS[layer];
  var w  = rnd(W*0.025, W*0.10);
  var h  = rnd(H*0.10,  H*lp.hScale);
  var y  = H*lp.yBase - h;
  var winW = rnd(2.5,5);
  var winH = rnd(3,6);
  var cols = Math.max(1, Math.floor((w-4) / (winW+3)));
  var rows = Math.max(1, Math.floor((h-6) / (winH+3)));
  var windows = [];
  for (var r=0; r<rows; r++) {
    for (var c=0; c<cols; c++) {
      windows.push({
        on:     Math.random() < 0.55,
        timer:  rndI(60, 900),
        hue:    Math.random()<0.7 ? rndI(40,60) : Math.random()<0.5 ? 200 : rndI(0,360),
        bright: rnd(70,100),
      });
    }
  }
  // roof antennas / tanks
  var roof = [];
  var nAnt = rndI(0,3);
  for (var i=0;i<nAnt;i++) {
    roof.push({ type:'antenna', rx: rnd(0.1,0.9), height: rnd(h*0.05, h*0.18) });
  }
  if (Math.random()<0.3) roof.push({ type:'tank', rx:rnd(0.2,0.8), r:rnd(w*0.04,w*0.10) });
  return { x:x, y:y, w:w, h:h, layer:layer, winW:winW, winH:winH, cols:cols, rows:rows, windows:windows, roof:roof };
}

function initScene() {
  buildings = [];
  // each layer
  for (var l=0; l<4; l++) {
    var lp = LAYERS[l];
    var x = -W*0.05;
    var density = l===3 ? 1.1 : 1.0;
    while (x < W*1.05) {
      var b = makeBuilding(l, x);
      buildings.push(b);
      x += b.w + rnd(0, W*0.01*density);
    }
  }
  // Tokyo Tower
  tokyoTower = makeTower();
  skyTree    = makeSkyTree();
  // Roads
  initRoads();
  // Rain
  initRain();
}

// ── TOKYO TOWER ──
var tokyoTower;
function makeTower() {
  var tx = W*0.30, baseY = H*0.78;
  var tw = W*0.028, th = H*0.38;
  return { x:tx, baseY:baseY, w:tw, h:th,
    light: { on:true, timer:30 } };
}

// ── SKYTREE ──
var skyTree;
function makeSkyTree() {
  var tx = W*0.72, baseY = H*0.76;
  var bw = W*0.022, th = H*0.50;
  return { x:tx, baseY:baseY, w:bw, h:th,
    ledColor: 0, ledTimer: 180 };
}

// ── ROADS / HIGHWAYS ──
var roads = [];
function initRoads() {
  roads = [];
  // Elevated highway - curves slightly
  roads.push({
    type: 'highway',
    y:    H*0.88,
    cars: [],
  });
  // Ground road
  roads.push({
    type: 'ground',
    y:    H*0.965,
    cars: [],
  });
  // Spawn initial cars
  for (var ri=0;ri<roads.length;ri++) {
    var road = roads[ri];
    for (var i=0;i<rndI(4,10);i++) {
      spawnCar(road, rnd(0,W));
    }
  }
}

function spawnCar(road, x) {
  var dir = Math.random()<0.5 ? 1 : -1;
  var speed = rnd(1.5, 4.5) * (road.type==='highway' ? 1.6 : 1.0);
  var isHead = Math.random()<0.5; // headlight (white) or taillight (red)
  road.cars.push({
    x: x, dir: dir, speed: speed * dir,
    isHead: isHead,
    brightness: rnd(0.7,1.0),
    streak: rnd(18,55),
    y: road.y + rnd(-2,2),
  });
}

// ── RAIN ──
var rainDrops = [];
function initRain() {
  rainDrops = [];
  for (var i=0; i<320; i++) {
    rainDrops.push(newRainDrop(true));
  }
}
function newRainDrop(random) {
  return {
    x:  rnd(0,W),
    y:  random ? rnd(0,H) : -10,
    len: rnd(8,22),
    spd: rnd(8,18),
    alpha: rnd(0.08,0.25),
  };
}

// ── RIVER REFLECTION ──
// Sumida River at bottom
var riverY, riverH;

// ── DRAW SKY ──
function drawSky() {
  var g = ctx.createLinearGradient(0,0,0,H*0.75);
  g.addColorStop(0,   '#020510');
  g.addColorStop(0.4, '#05091a');
  g.addColorStop(0.8, '#0d1228');
  g.addColorStop(1,   '#141830');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H*0.75);

  // City light glow on horizon
  var hg = ctx.createLinearGradient(0, H*0.55, 0, H*0.82);
  hg.addColorStop(0, 'rgba(0,0,0,0)');
  hg.addColorStop(0.5,'rgba(255,140,40,0.12)');
  hg.addColorStop(1,  'rgba(255,100,20,0.22)');
  ctx.fillStyle=hg; ctx.fillRect(0,H*0.55,W,H*0.28);

  // Stars
  ctx.fillStyle = 'rgba(255,255,255,0.0)'; // drawn separately
}

// ── DRAW STARS ──
var starData = null;
function initStars() {
  starData = [];
  for (var i=0;i<120;i++) {
    starData.push({ x:Math.random(), y:Math.random()*0.5, r:rnd(0.3,1.2), ph:rnd(0,6.28), sp:rnd(0.005,0.02) });
  }
}
function drawStars() {
  if (!starData) return;
  for (var i=0;i<starData.length;i++) {
    var s = starData[i];
    var tw = 0.3 + 0.7*Math.sin(T*s.sp+s.ph);
    // Fade out near horizon (city glow)
    var horizonFade = clamp(1-(s.y-0.3)*3, 0, 1);
    ctx.globalAlpha = tw * 0.5 * horizonFade;
    ctx.fillStyle = '#c8d8ff';
    ctx.beginPath(); ctx.arc(s.x*W, s.y*H, s.r, 0, Math.PI*2); ctx.fill();
  }
  ctx.globalAlpha = 1;
}

// ── DRAW MOON ──
function drawMoon() {
  var mx=W*0.15, my=H*0.10, mr=W*0.018;
  // halo
  var mg=ctx.createRadialGradient(mx,my,0,mx,my,mr*5);
  mg.addColorStop(0,'rgba(220,220,180,0.12)'); mg.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=mg; ctx.beginPath(); ctx.arc(mx,my,mr*5,0,Math.PI*2); ctx.fill();
  // body
  var mb=ctx.createRadialGradient(mx-mr*0.2,my-mr*0.2,mr*0.05,mx,my,mr);
  mb.addColorStop(0,'#f0e8c8'); mb.addColorStop(1,'#b8a870');
  ctx.fillStyle=mb; ctx.beginPath(); ctx.arc(mx,my,mr,0,Math.PI*2); ctx.fill();
}

// ── DRAW CLOUDS / FOG ──
function drawFog() {
  // Low-lying fog over city
  var fy = H*0.65;
  for (var i=0;i<5;i++) {
    var fi = i/4;
    var fx = Math.sin(T*0.003+fi*2.1)*W*0.12 + fi*W*0.22;
    var fr = W*(0.12+0.08*fi);
    var fg = ctx.createRadialGradient(fx,fy,0,fx,fy,fr);
    fg.addColorStop(0,'rgba(180,160,200,0.05)');
    fg.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=fg; ctx.beginPath(); ctx.arc(fx,fy,fr,0,Math.PI*2); ctx.fill();
  }
}

// ── DRAW SKYTREE ──
function drawSkyTree() {
  var st = skyTree;
  var tx = st.x, by = st.baseY, th = st.h;
  var bw = st.w;

  // Body - tapers
  ctx.fillStyle = '#0a0a14';
  ctx.beginPath();
  ctx.moveTo(tx-bw*0.5, by);
  ctx.lineTo(tx-bw*0.08, by-th*0.7);
  ctx.lineTo(tx, by-th);
  ctx.lineTo(tx+bw*0.08, by-th*0.7);
  ctx.lineTo(tx+bw*0.5, by);
  ctx.closePath(); ctx.fill();

  // LED ring colors
  var ledColors = ['#00aaff','#4400ff','#00ffcc','#ff0066'];
  st.ledTimer--;
  if (st.ledTimer<=0) { st.ledColor=(st.ledColor+1)%ledColors.length; st.ledTimer=180+rndI(0,120); }
  var lc = ledColors[st.ledColor];

  // 2 observation decks
  [0.35, 0.45].forEach(function(frac) {
    var dy = by - th*frac;
    var dw = bw * (1.8 - frac);
    ctx.fillStyle = '#181828';
    ctx.fillRect(tx-dw, dy-4, dw*2, 8);
    ctx.strokeStyle = lc;
    ctx.globalAlpha = 0.6+0.4*Math.sin(T*0.04);
    ctx.lineWidth = 1;
    ctx.strokeRect(tx-dw, dy-4, dw*2, 8);
    ctx.globalAlpha = 1;
  });

  // Top antenna blink
  var blinkOn = Math.floor(T/25)%2===0;
  if (blinkOn) {
    ctx.fillStyle = '#ff2020';
    ctx.beginPath(); ctx.arc(tx, by-th, 3, 0, Math.PI*2); ctx.fill();
    var ag=ctx.createRadialGradient(tx,by-th,0,tx,by-th,12);
    ag.addColorStop(0,'rgba(255,30,30,0.6)'); ag.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=ag; ctx.beginPath(); ctx.arc(tx,by-th,12,0,Math.PI*2); ctx.fill();
  }

  // LED glow on structure
  var lgg=ctx.createRadialGradient(tx,by-th*0.4,0,tx,by-th*0.4,bw*3);
  lgg.addColorStop(0,lc.replace(')',',0.08)').replace('rgb','rgba'));
  lgg.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=lgg; ctx.beginPath(); ctx.arc(tx,by-th*0.4,bw*3,0,Math.PI*2); ctx.fill();
}

// ── DRAW TOKYO TOWER ──
function drawTokyoTower() {
  var tt = tokyoTower;
  var tx=tt.x, by=tt.baseY, th=tt.h, tw=tt.w;

  // Lattice structure
  ctx.strokeStyle = '#2a1a08';
  ctx.lineWidth = 1.5;

  // Main silhouette
  ctx.fillStyle = '#1a0e04';
  ctx.beginPath();
  ctx.moveTo(tx-tw*0.5, by);
  ctx.lineTo(tx-tw*0.12, by-th*0.6);
  ctx.lineTo(tx-tw*0.06, by-th);
  ctx.lineTo(tx+tw*0.06, by-th);
  ctx.lineTo(tx+tw*0.12, by-th*0.6);
  ctx.lineTo(tx+tw*0.5, by);
  ctx.closePath(); ctx.fill(); ctx.stroke();

  // Observation deck
  var od1y = by-th*0.42;
  ctx.fillStyle = '#251508';
  ctx.fillRect(tx-tw*0.7, od1y-5, tw*1.4, 10);
  ctx.fillRect(tx-tw*0.45, od1y-5-tw*0.4, tw*0.9, tw*0.4);

  // Orange lights
  var orangeAlpha = 0.7+0.3*Math.sin(T*0.02);
  ctx.globalAlpha = orangeAlpha;
  // Cross lights on body
  for (var i=0;i<6;i++) {
    var ly = by - th*(0.15+i*0.13);
    var lw = tw*(0.5-i*0.07);
    ctx.fillStyle='#ff6010';
    ctx.fillRect(tx-lw*0.5, ly-1, lw, 2);
  }
  ctx.globalAlpha=1;

  // Top blink
  tt.light.timer--;
  if (tt.light.timer<=0) { tt.light.on=!tt.light.on; tt.light.timer=rndI(20,40); }
  if (tt.light.on) {
    ctx.fillStyle='#ffffff';
    ctx.beginPath(); ctx.arc(tx,by-th,2.5,0,Math.PI*2); ctx.fill();
    var tlg=ctx.createRadialGradient(tx,by-th,0,tx,by-th,14);
    tlg.addColorStop(0,'rgba(255,200,100,0.5)'); tlg.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=tlg; ctx.beginPath(); ctx.arc(tx,by-th,14,0,Math.PI*2); ctx.fill();
  }
}

// ── DRAW BUILDINGS ──
function drawBuildings(layer) {
  var lp = LAYERS[layer];
  var layerBuildings = buildings.filter(function(b){ return b.layer===layer; });

  for (var bi=0;bi<layerBuildings.length;bi++) {
    var b = layerBuildings[bi];

    // Building body
    var dark = Math.floor(lerp(5, 22, layer/3));
    var bg = ctx.createLinearGradient(b.x, b.y, b.x+b.w, b.y+b.h);
    bg.addColorStop(0, 'rgb('+(dark+4)+','+(dark+2)+','+(dark+8)+')');
    bg.addColorStop(1, 'rgb('+dark+','+dark+','+(dark+3)+')');
    ctx.fillStyle = bg;
    ctx.globalAlpha = lp.alpha;
    ctx.fillRect(b.x, b.y, b.w, b.h);
    ctx.globalAlpha = 1;

    // Windows
    var padX = (b.w - b.cols*(b.winW+3)+3) / 2;
    var padY = 5;
    for (var r=0;r<b.rows;r++) {
      for (var c=0;c<b.cols;c++) {
        var idx = r*b.cols+c;
        var win = b.windows[idx];
        var wx = b.x + padX + c*(b.winW+3);
        var wy = b.y + padY + r*(b.winH+3);

        // Update window state
        win.timer--;
        if (win.timer<=0) {
          win.on    = Math.random()<0.5;
          win.timer = rndI(60,800);
        }

        if (win.on) {
          var wa = lp.winAlpha * (0.6+0.4*Math.sin(T*0.01+idx));
          ctx.globalAlpha = wa;
          ctx.fillStyle = 'hsl('+win.hue+',60%,'+win.bright+'%)';
          ctx.fillRect(wx, wy, b.winW, b.winH);
          // Warm glow
          if (layer>=2) {
            var wg=ctx.createRadialGradient(wx+b.winW/2,wy+b.winH/2,0,wx+b.winW/2,wy+b.winH/2,b.winW*3);
            wg.addColorStop(0,'hsla('+win.hue+',80%,70%,'+(wa*0.15)+')');
            wg.addColorStop(1,'rgba(0,0,0,0)');
            ctx.fillStyle=wg;
            ctx.fillRect(wx-b.winW*2,wy-b.winH*2,b.winW*5,b.winH*5);
          }
          ctx.globalAlpha=1;
        }
      }
    }

    // Roof details
    ctx.globalAlpha = lp.alpha;
    for (var ri=0;ri<b.roof.length;ri++) {
      var ro=b.roof[ri];
      if (ro.type==='antenna') {
        var ax = b.x+b.w*ro.rx, ay = b.y;
        ctx.strokeStyle='#303040'; ctx.lineWidth=1;
        ctx.beginPath(); ctx.moveTo(ax,ay); ctx.lineTo(ax,ay-ro.height); ctx.stroke();
        // Blink
        if (Math.floor(T/40+ri*7)%2===0) {
          ctx.fillStyle='#ff3030';
          ctx.beginPath(); ctx.arc(ax,ay-ro.height,1.5,0,Math.PI*2); ctx.fill();
        }
      } else if (ro.type==='tank') {
        var tkx=b.x+b.w*ro.rx, tky=b.y-ro.r*0.8;
        ctx.fillStyle='#282838';
        ctx.beginPath(); ctx.arc(tkx,tky,ro.r,0,Math.PI*2); ctx.fill();
      }
    }
    ctx.globalAlpha=1;
  }
}

// ── DRAW ROADS ──
function drawRoads() {
  for (var ri=0;ri<roads.length;ri++) {
    var road = roads[ri];
    var ry = road.y;
    var isHighway = road.type==='highway';

    // Road surface
    var rg = ctx.createLinearGradient(0,ry-3,0,ry+6);
    rg.addColorStop(0, isHighway?'#0d0d18':'#101018');
    rg.addColorStop(1, isHighway?'#080810':'#0a0a10');
    ctx.fillStyle=rg; ctx.fillRect(0,ry-4,W,10);

    // Guardrail / divider
    if (isHighway) {
      ctx.strokeStyle='rgba(80,80,100,0.4)';
      ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(0,ry-4); ctx.lineTo(W,ry-4); ctx.stroke();
    }

    // Road reflection strip
    var refAlpha = 0.06+0.04*Math.sin(T*0.02);
    ctx.fillStyle='rgba(200,180,255,'+refAlpha+')';
    ctx.fillRect(0,ry,W,2);

    // Cars
    for (var ci=roads[ri].cars.length-1;ci>=0;ci--) {
      var car = roads[ri].cars[ci];
      car.x += car.speed;
      if (car.x > W+80)  roads[ri].cars.splice(ci,1);
      if (car.x < -80)   roads[ri].cars.splice(ci,1);

      // Draw car light streaks
      var sx  = car.x;
      var sy  = car.y;
      var len = car.streak * Math.abs(car.speed)/3;
      var col = car.isHead ? '255,250,220' : '220,30,10';
      var alpha = car.brightness * (isHighway ? 0.9 : 0.7);

      var lg = ctx.createLinearGradient(sx, sy, sx - car.dir*len, sy);
      lg.addColorStop(0, 'rgba('+col+','+alpha+')');
      lg.addColorStop(1, 'rgba('+col+',0)');
      ctx.strokeStyle = lg;
      ctx.lineWidth = isHighway ? rnd(1.5,2.5) : rnd(1,2);
      ctx.lineCap = 'round';
      ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(sx-car.dir*len,sy); ctx.stroke();

      // Lead dot
      ctx.fillStyle='rgba('+col+','+alpha+')';
      ctx.beginPath(); ctx.arc(sx,sy,isHighway?1.8:1.2,0,Math.PI*2); ctx.fill();

      // Reflection on wet road
      var refY = ry+3;
      var rlg = ctx.createLinearGradient(sx,refY,sx-car.dir*len*0.5,refY);
      rlg.addColorStop(0,'rgba('+col+','+(alpha*0.3)+')');
      rlg.addColorStop(1,'rgba('+col+',0)');
      ctx.strokeStyle=rlg; ctx.lineWidth=isHighway?1.5:1;
      ctx.beginPath(); ctx.moveTo(sx,refY); ctx.lineTo(sx-car.dir*len*0.5,refY); ctx.stroke();
    }

    // Spawn new cars
    if (Math.random()<0.015) {
      var dir = Math.random()<0.5 ? 1 : -1;
      spawnCar(road, dir>0 ? -40 : W+40);
    }
  }
}

// ── DRAW RIVER ──
function drawRiver() {
  var ry = H*0.92, rh = H*0.08;
  riverY = ry; riverH = rh;

  var rg=ctx.createLinearGradient(0,ry,0,ry+rh);
  rg.addColorStop(0,'#03050f'); rg.addColorStop(1,'#020308');
  ctx.fillStyle=rg; ctx.fillRect(0,ry,W,rh);

  // Wave shimmer
  for (var i=0;i<6;i++) {
    var wy = ry + rh*(0.2+i*0.12);
    var wx = Math.sin(T*0.015+i*1.3)*W*0.03;
    var wg=ctx.createLinearGradient(0,wy,0,wy+2);
    wg.addColorStop(0,'rgba(80,100,160,'+(0.06+0.04*Math.sin(T*0.02+i))+')');
    wg.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=wg; ctx.fillRect(wx,wy,W,2);
  }

  // Reflections of city lights in river
  var refBuildings = buildings.filter(function(b){ return b.layer>=2; });
  for (var bi=0;bi<refBuildings.length;bi+=3) {
    var b = refBuildings[bi];
    var refH = (H - b.y - b.h) * 0.3;
    var refAlpha = 0.04+0.02*Math.sin(T*0.01+bi);
    var rflg=ctx.createLinearGradient(b.x+b.w/2,ry,b.x+b.w/2,ry+rh);
    rflg.addColorStop(0,'rgba(255,200,100,'+refAlpha+')');
    rflg.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=rflg;
    ctx.fillRect(b.x+b.w*0.1, ry, b.w*0.8, Math.min(rh*0.7, refH));
  }

  // Tokyo Tower orange reflection
  var ttx=tokyoTower.x;
  var ttg=ctx.createRadialGradient(ttx,ry+rh*0.3,0,ttx,ry+rh*0.3,W*0.08);
  ttg.addColorStop(0,'rgba(255,100,20,0.12)'); ttg.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=ttg; ctx.fillRect(ttx-W*0.08,ry,W*0.16,rh);
}

// ── DRAW RAIN ──
function drawRain() {
  ctx.strokeStyle='rgba(180,200,255,0.18)';
  ctx.lineWidth=0.7;
  for (var i=0;i<rainDrops.length;i++) {
    var d=rainDrops[i];
    d.y+=d.spd; d.x+=0.8; // slight angle
    if (d.y>H+10) rainDrops[i]=newRainDrop(false);
    ctx.globalAlpha=d.alpha;
    ctx.beginPath(); ctx.moveTo(d.x,d.y); ctx.lineTo(d.x+3,d.y+d.len); ctx.stroke();
  }
  ctx.globalAlpha=1;
}

// ── DRAW GROUND ──
function drawGround() {
  var gy = H*0.89;
  // Wet pavement
  var gg=ctx.createLinearGradient(0,gy,0,H*0.92);
  gg.addColorStop(0,'#0a080e'); gg.addColorStop(1,'#050508');
  ctx.fillStyle=gg; ctx.fillRect(0,gy,W,H*0.92-gy);

  // Puddle reflections
  for (var i=0;i<4;i++) {
    var px=W*(0.1+i*0.25), py=gy+4;
    var pg=ctx.createRadialGradient(px,py,0,px,py,W*0.06);
    var pa=0.08+0.05*Math.sin(T*0.02+i);
    pg.addColorStop(0,'rgba(255,180,80,'+pa+')');
    pg.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=pg; ctx.fillRect(px-W*0.06,py-5,W*0.12,10);
  }
}

// ── VIGNETTE ──
function drawVignette() {
  var vg=ctx.createRadialGradient(W/2,H/2,H*0.3,W/2,H/2,H*0.9);
  vg.addColorStop(0,'rgba(0,0,0,0)');
  vg.addColorStop(1,'rgba(0,0,0,0.82)');
  ctx.fillStyle=vg; ctx.fillRect(0,0,W,H);
}

// ── HAZE OVERLAY ──
function drawHaze() {
  // Atmospheric haze between layers
  var hg=ctx.createLinearGradient(0,H*0.55,0,H*0.85);
  hg.addColorStop(0,'rgba(10,8,25,0)');
  hg.addColorStop(0.5,'rgba(20,15,40,0.15)');
  hg.addColorStop(1,'rgba(10,8,20,0)');
  ctx.fillStyle=hg; ctx.fillRect(0,H*0.55,W,H*0.30);
}

// ── MAIN LOOP ──
function frame() {
  ctx.clearRect(0,0,W,H);

  drawSky();
  drawStars();
  drawMoon();
  drawFog();

  // Far buildings
  drawBuildings(0);
  drawBuildings(1);

  // Landmarks behind mid buildings
  drawSkyTree();
  drawTokyoTower();

  // Mid / near buildings
  drawBuildings(2);
  drawBuildings(3);

  drawHaze();
  drawGround();
  drawRoads();
  drawRiver();
  drawRain();
  drawVignette();

  T++;
  requestAnimationFrame(frame);
}

initStars();
initScene();
frame();
})();
</script>
</body>
</html>
