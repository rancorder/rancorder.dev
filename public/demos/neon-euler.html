<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NEON EULER â€” ä¸€ç­†æ›¸ã</title>
<style>
*, *::before, *::after {
  margin: 0; padding: 0; box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}
html, body {
  width: 100%; height: 100%;
  overflow: hidden;
  touch-action: none;
  overscroll-behavior: none;
}
body {
  background: #060612;
  color: #e2e8f0;
  font-family: 'Courier New', Courier, monospace;
  display: flex;
  flex-direction: column;
  align-items: center;
  user-select: none;
  -webkit-user-select: none;
}

/* HEADER */
#header {
  width: 100%; max-width: 600px;
  padding: 10px 16px 6px;
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0; gap: 8px;
}
#logo {
  font-size: 1.1rem; font-weight: 900; letter-spacing: 0.15em;
  background: linear-gradient(90deg, #00d9ff, #a855f7);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 10px rgba(168,85,247,.6));
  white-space: nowrap;
}
#meta-row { display: flex; gap: 10px; flex-shrink: 0; }
#timer, #moves-display {
  font-size: 0.72rem; color: rgba(255,255,255,0.45);
  min-width: 52px; text-align: center;
}
#timer span, #moves-display span { color: #00d9ff; }

/* DIFF BAR */
#diff-bar {
  width: 100%; max-width: 600px;
  display: flex; gap: 5px;
  padding: 0 16px 6px; flex-shrink: 0;
}
.diff-btn {
  flex: 1; padding: 5px 2px;
  font-family: inherit; font-size: 0.58rem; font-weight: 700;
  letter-spacing: 0.04em; text-align: center; line-height: 1.4;
  border: 1.5px solid rgba(255,255,255,0.15); border-radius: 6px;
  background: rgba(255,255,255,0.04); color: rgba(255,255,255,0.4);
  cursor: pointer; touch-action: manipulation; transition: all 0.2s;
}
.diff-btn.active {
  border-color: var(--c, #a855f7); color: var(--c, #a855f7);
  background: rgba(168,85,247,0.1);
  box-shadow: 0 0 10px -2px var(--c, #a855f7);
}

/* CANVAS AREA */
#canvas-wrap {
  position: relative; flex: 1;
  width: 100%; max-width: 600px;
  padding: 4px 16px;
  display: flex; align-items: center; justify-content: center;
  min-height: 0;
}
#canvas {
  display: block; border-radius: 14px; cursor: crosshair;
  touch-action: none;
}

/* OVERLAY â€” canvas ã®å¤–å´ã«ç½®ã (z-indexã§å‰é¢ã¸) */
#overlay {
  position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  pointer-events: none; z-index: 30;
  border-radius: 14px;
}
#overlay-box {
  background: rgba(6,6,18,0.94);
  border: 2px solid #a855f7; border-radius: 18px;
  padding: 24px 32px; text-align: center;
  transform: scale(0);
  transition: transform 0.3s cubic-bezier(.34,1.56,.64,1);
  min-width: 210px;
}
#overlay.show { pointer-events: auto; }
#overlay.show #overlay-box { transform: scale(1); }
#ov-title { font-size: 1.4rem; letter-spacing: 0.2em; margin-bottom: 6px; }
#ov-sub   { font-size: 0.72rem; color: rgba(255,255,255,0.5); margin-bottom: 8px; }
#ov-stat  { font-size: 0.85rem; color: #00d9ff; margin-bottom: 16px; letter-spacing: 0.1em; }
#btn-next {
  width: 100%; padding: 12px;
  font-family: inherit; font-size: 0.9rem; font-weight: 700; letter-spacing: 0.08em;
  border: 2px solid #a855f7; border-radius: 10px;
  background: rgba(168,85,247,0.15); color: #a855f7;
  cursor: pointer; touch-action: manipulation; transition: background 0.15s;
}
#btn-next:active { background: rgba(168,85,247,0.35); }

/* FOOTER */
#footer {
  width: 100%; max-width: 600px;
  padding: 6px 16px 14px;
  display: flex; gap: 8px; flex-shrink: 0;
}
.ctrl-btn {
  flex: 1; padding: 10px 6px;
  font-family: inherit; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.06em;
  border: 1.5px solid rgba(255,255,255,0.18); border-radius: 10px;
  background: rgba(255,255,255,0.04); color: rgba(255,255,255,0.65);
  cursor: pointer; touch-action: manipulation; transition: background 0.15s;
}
.ctrl-btn:active { background: rgba(255,255,255,0.12); }
.ctrl-btn.primary { border-color:#a855f7;color:#a855f7;background:rgba(168,85,247,0.08); }
.ctrl-btn.primary:active { background: rgba(168,85,247,0.25); }
#hint-count { font-size: 0.58rem; color: rgba(255,255,255,0.38); display: block; }

@keyframes shake {
  0%,100%{transform:translateX(0)}
  20%{transform:translateX(-7px)}
  50%{transform:translateX(7px)}
  80%{transform:translateX(-4px)}
}
.shake { animation: shake 0.32s ease; }
</style>
</head>
<body>

<!-- DEMO_META
title: NEON EULER
desc: ä¸€ç­†æ›¸ããƒ‘ã‚ºãƒ« â€” 5æ®µéšé›£æ˜“åº¦ Â· ç„¡é™ã‚¹ãƒ†ãƒ¼ã‚¸ç”Ÿæˆ
tech: Canvas 2D Â· Graph Theory Â· Eulerian Path
level: 90
color: #a855f7
type: game
-->

<div id="header">
  <div id="logo">âœ¦ NEON EULER</div>
  <div id="meta-row">
    <div id="moves-display">æ‰‹æ•° <span id="mv">0</span></div>
    <div id="timer">â± <span id="tm">0:00</span></div>
  </div>
</div>

<div id="diff-bar">
  <button class="diff-btn" data-d="0" style="--c:#22d3ee">EASY<br><small>å…¥é–€</small></button>
  <button class="diff-btn" data-d="1" style="--c:#a855f7">NORMAL<br><small>æ™®é€š</small></button>
  <button class="diff-btn active" data-d="2" style="--c:#f59e0b">HARD<br><small>é›£</small></button>
  <button class="diff-btn" data-d="3" style="--c:#ec4899">EXPERT<br><small>è¶…é›£</small></button>
  <button class="diff-btn" data-d="4" style="--c:#ef4444">MASTER<br><small>é”äºº</small></button>
</div>

<div id="canvas-wrap">
  <canvas id="canvas"></canvas>
  <div id="overlay">
    <div id="overlay-box">
      <div id="ov-title">ğŸ‰ ã‚¯ãƒªã‚¢ï¼</div>
      <div id="ov-sub"></div>
      <div id="ov-stat"></div>
      <button id="btn-next">æ¬¡ã®ãƒ‘ã‚ºãƒ« â†’</button>
    </div>
  </div>
</div>

<div id="footer">
  <button class="ctrl-btn" id="btn-undo">â†© ã‚‚ã©ã™</button>
  <button class="ctrl-btn" id="btn-hint">ğŸ’¡ ãƒ’ãƒ³ãƒˆ<span id="hint-count"></span></button>
  <button class="ctrl-btn" id="btn-reset">â†º ãƒªã‚»ãƒƒãƒˆ</button>
  <button class="ctrl-btn primary" id="btn-new">NEW âœ¦</button>
</div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  [FIX-A] ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ å®Œå…¨å°é–
//  iOS10+ ã¯ user-scalable=no ã‚’ç„¡è¦–ã™ã‚‹ãŸã‚
//  gestureç³»ã‚¤ãƒ™ãƒ³ãƒˆã¨2æœ¬æŒ‡touchmoveã§ãƒ–ãƒ­ãƒƒã‚¯
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
['gesturestart','gesturechange','gestureend'].forEach(t =>
  document.addEventListener(t, e => e.preventDefault(), {passive:false})
);
document.addEventListener('touchmove', e => {
  if (e.touches.length > 1) e.preventDefault();
}, {passive:false});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DIFFS = [
  {id:0, name:'EASY',   color:'#22d3ee', label:'å…¥é–€', nodes:4,  tri:0, extra:0},
  {id:1, name:'NORMAL', color:'#a855f7', label:'æ™®é€š', nodes:6,  tri:1, extra:1},
  {id:2, name:'HARD',   color:'#f59e0b', label:'é›£',   nodes:8,  tri:2, extra:2},
  {id:3, name:'EXPERT', color:'#ec4899', label:'è¶…é›£', nodes:11, tri:4, extra:3},
  {id:4, name:'MASTER', color:'#ef4444', label:'é”äºº', nodes:14, tri:6, extra:5},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const rnd   = () => Math.random();
const range = n  => Array.from({length:n},(_,i)=>i);
const hypot = (ax,ay,bx,by) => Math.hypot(ax-bx,ay-by);
const lerp  = (a,b,t) => a+(b-a)*t;
const ekey  = (a,b) => a<b?`${a}:${b}`:`${b}:${a}`;
function shuffle(arr) {
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){const j=0|rnd()*(i+1);[a[i],a[j]]=[a[j],a[i]];}
  return a;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GRAPH â€” ã‚ªã‚¤ãƒ©ãƒ¼å›è·¯ä¿è¨¼ã‚°ãƒ©ãƒ•ç”Ÿæˆ
//  å…¨ãƒãƒ¼ãƒ‰æ¬¡æ•°ãŒå¶æ•° â†’ ã‚ªã‚¤ãƒ©ãƒ¼å›è·¯å¿…ãšå­˜åœ¨
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildGraph(N, triCount, extraPairs) {
  const edges=[]; const es=new Set(); const deg=new Array(N).fill(0);
  function addEdge(a,b) {
    if(a===b)return false;
    const k=ekey(a,b);
    if(es.has(k))return false;
    es.add(k);edges.push({id:edges.length,a,b});
    deg[a]++;deg[b]++;return true;
  }
  // ãƒãƒŸãƒ«ãƒˆãƒ³é–‰è·¯ (æ¬¡æ•°2, å…¨å¶æ•°)
  const perm=shuffle(range(N));
  for(let i=0;i<N;i++) addEdge(perm[i],perm[(i+1)%N]);
  // ä¸‰è§’å½¢ (+2 per node, å¶æ•°ç¶­æŒ)
  for(let t=0,att=0;t<triCount&&att<3000;att++){
    const [a,b,c]=shuffle(range(N));
    if(!es.has(ekey(a,b))&&!es.has(ekey(b,c))&&!es.has(ekey(a,c))){
      addEdge(a,b);addEdge(b,c);addEdge(a,c);t++;
    }
  }
  // è¿½åŠ ãƒšã‚¢è¾º (+2 per node pair, å¶æ•°ç¶­æŒ)
  for(let p=0,att=0;p<extraPairs&&att<3000;att++){
    const pool=shuffle(range(N));
    const r1=addEdge(pool[0],pool[1]);
    const r2=addEdge(pool[2]??0,pool[3]??1);
    if(r1&&r2)p++;
  }
  return {edges,deg};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NODE PLACEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function placeNodes(count,cx,cy,radius) {
  if(count<=8){
    return range(count).map(i=>{
      const a=(i/count)*Math.PI*2-Math.PI/2+(rnd()-.5)*.35;
      const r=radius*(.85+rnd()*.15);
      return {id:i,x:cx+r*Math.cos(a),y:cy+r*Math.sin(a)};
    });
  }
  const inner=Math.floor(count*.4),outer=count-inner,nodes=[];
  for(let i=0;i<inner;i++){
    const a=(i/inner)*Math.PI*2+rnd()*.2;
    nodes.push({id:i,x:cx+radius*.42*Math.cos(a),y:cy+radius*.42*Math.sin(a)});
  }
  for(let i=0;i<outer;i++){
    const a=(i/outer)*Math.PI*2-Math.PI/2+rnd()*.15;
    const r=radius*(.88+rnd()*.12);
    nodes.push({id:inner+i,x:cx+r*Math.cos(a),y:cy+r*Math.sin(a)});
  }
  return nodes;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PUZZLE STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Puzzle {
  constructor(nodes,edges,deg,color) {
    this.nodes=nodes; this.edges=edges; this.totalE=edges.length;
    this.deg=deg; this.color=color;
    this.adj=nodes.map(()=>[]);
    for(const e of edges){
      this.adj[e.a].push({eid:e.id,nb:e.b});
      this.adj[e.b].push({eid:e.id,nb:e.a});
    }
    const odd=deg.map((d,i)=>d%2===1?i:-1).filter(i=>i!==-1);
    this.endpoints=odd.length===2?odd:null;
    this.reset();
  }
  reset(){
    this.traversed=new Set();this.stack=[];
    this.cur=null;this.moves=0;this.won=false;this.animE={};
  }
  canStart(id){
    if(this.cur!==null)return false;
    return this.endpoints===null||this.endpoints.includes(id);
  }
  start(id){this.cur=id;}
  freeEdges(id){
    if(id===null||id===undefined)return[];
    return this.adj[id].filter(x=>!this.traversed.has(x.eid));
  }
  move(to){
    if(this.won||this.cur===null||to===this.cur)return'noop';
    if(this.stack.length>0&&this.stack[this.stack.length-1].from===to){
      const last=this.stack.pop();
      this.traversed.delete(last.eid);this.cur=to;this.moves++;return'back';
    }
    const edge=this.adj[this.cur].find(x=>x.nb===to&&!this.traversed.has(x.eid));
    if(!edge)return'bad';
    this.traversed.add(edge.eid);this.animE[edge.eid]=0;
    this.stack.push({from:this.cur,to,eid:edge.eid});
    this.cur=to;this.moves++;
    if(this.traversed.size===this.totalE){this.won=true;return'win';}
    return'ok';
  }
  undo(){
    if(this.stack.length===0)return false;
    const last=this.stack.pop();
    this.traversed.delete(last.eid);this.cur=last.from;this.moves++;return true;
  }
  deadEnd(){
    return this.cur!==null&&!this.won&&this.freeEdges(this.cur).length===0&&this.traversed.size<this.totalE;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARTICLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Pt {
  constructor(x,y,c){
    this.x=x;this.y=y;this.c=c;
    const a=rnd()*Math.PI*2,s=2+rnd()*5;
    this.vx=Math.cos(a)*s;this.vy=Math.sin(a)*s-1.5;
    this.life=1;this.decay=.016+rnd()*.018;this.r=2+rnd()*3.5;
  }
  tick(){this.x+=this.vx;this.y+=this.vy;this.vy+=.1;this.vx*=.97;this.life-=this.decay;}
  draw(ctx){
    if(this.life<=0)return;
    ctx.save();ctx.globalAlpha=this.life;
    ctx.fillStyle=ctx.shadowColor=this.c;ctx.shadowBlur=5;
    ctx.beginPath();ctx.arc(this.x,this.y,this.r*this.life,0,Math.PI*2);ctx.fill();
    ctx.restore();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDERER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Renderer {
  constructor(cv){
    this.cv=cv;this.ctx=cv.getContext('2d');
    this.W=0;this.H=0;this.NR=20;this.pts=[];
  }
  // [FIX-C] canvaså±æ€§ã¨CSSã‚µã‚¤ã‚ºã‚’åŒæ™‚è¨­å®š
  resize(){
    const wrap=this.cv.parentElement;
    const W=Math.floor(wrap.clientWidth-32);
    const H=Math.floor(wrap.clientHeight-8);
    if(W<=0||H<=0)return;
    this.W=W;this.H=H;
    this.cv.width=W;this.cv.height=H;
    this.cv.style.width=W+'px';this.cv.style.height=H+'px';
    this.NR=Math.min(22,Math.max(13,Math.min(W,H)/20));
  }
  burst(nodes,color,n=14){
    for(const nd of nodes)for(let i=0;i<n;i++)this.pts.push(new Pt(nd.x,nd.y,color));
  }
  draw(pz,hover,hintEids,cursor){
    const{ctx,W,H,NR}=this;
    if(!W)return;
    ctx.fillStyle='#060612';ctx.fillRect(0,0,W,H);
    // ã‚°ãƒªãƒƒãƒ‰
    ctx.strokeStyle='rgba(168,85,247,0.035)';ctx.lineWidth=1;
    for(let x=0;x<W;x+=40){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
    for(let y=0;y<H;y+=40){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
    // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
    this.pts=this.pts.filter(p=>p.life>0);
    for(const p of this.pts){p.tick();p.draw(ctx);}
    if(!pz)return;
    const{nodes,edges,traversed,cur,color,animE}=pz;
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€²è¡Œ
    for(const eid of Object.keys(animE)){
      if(animE[eid]<1)animE[eid]=Math.min(1,animE[eid]+.1);
    }
    // è¾º
    for(const e of edges){
      const A=nodes[e.a],B=nodes[e.b];
      const done=traversed.has(e.id);
      const prog=animE[e.id]??(done?1:-1);
      const isHint=hintEids&&hintEids.includes(e.id);
      if(done&&prog>=0&&prog<1){
        const mx=lerp(A.x,B.x,prog),my=lerp(A.y,B.y,prog);
        ctx.save();ctx.lineCap='round';
        ctx.strokeStyle='rgba(255,255,255,0.09)';ctx.lineWidth=2.5;
        ctx.beginPath();ctx.moveTo(mx,my);ctx.lineTo(B.x,B.y);ctx.stroke();
        ctx.strokeStyle=color;ctx.shadowColor=color;ctx.shadowBlur=16;ctx.lineWidth=3.5;
        ctx.beginPath();ctx.moveTo(A.x,A.y);ctx.lineTo(mx,my);ctx.stroke();
        ctx.restore();
      } else if(done){
        ctx.save();ctx.lineCap='round';ctx.strokeStyle=color;
        ctx.shadowColor=color;ctx.shadowBlur=12;ctx.lineWidth=3.5;ctx.globalAlpha=.88;
        ctx.beginPath();ctx.moveTo(A.x,A.y);ctx.lineTo(B.x,B.y);ctx.stroke();ctx.restore();
      } else {
        ctx.save();ctx.lineCap='round';
        if(isHint){
          ctx.strokeStyle='#fff';ctx.shadowColor='#fff';ctx.shadowBlur=8;
          ctx.globalAlpha=.4+.35*Math.sin(Date.now()/250);ctx.lineWidth=2.5;
        } else {
          ctx.strokeStyle='rgba(255,255,255,0.12)';ctx.lineWidth=2;
        }
        ctx.beginPath();ctx.moveTo(A.x,A.y);ctx.lineTo(B.x,B.y);ctx.stroke();ctx.restore();
      }
    }
    // ãƒ‰ãƒ©ãƒƒã‚°ãƒ©ã‚¤ãƒ³
    if(cur!==null&&cursor){
      const cn=nodes[cur];
      ctx.save();ctx.strokeStyle=color;ctx.shadowColor=color;ctx.shadowBlur=6;
      ctx.globalAlpha=.45;ctx.lineWidth=2;ctx.lineCap='round';ctx.setLineDash([6,5]);
      ctx.beginPath();ctx.moveTo(cn.x,cn.y);ctx.lineTo(cursor.x,cursor.y);ctx.stroke();
      ctx.restore();
    }
    // ãƒãƒ¼ãƒ‰
    for(const n of nodes){
      const isCur=n.id===cur;
      const isAdj=cur!==null&&pz.freeEdges(cur).some(x=>x.nb===n.id);
      const isStart=cur===null&&pz.canStart(n.id);
      if(isCur||isAdj||isStart||n.id===hover){
        ctx.save();ctx.beginPath();ctx.arc(n.x,n.y,NR+7,0,Math.PI*2);
        ctx.strokeStyle=isCur?color:(isAdj?color:'rgba(255,255,255,.25)');
        ctx.shadowColor=color;ctx.shadowBlur=isCur?22:8;
        ctx.globalAlpha=isCur?.9:(isAdj?.5:.3);ctx.lineWidth=isCur?2.5:1.5;
        ctx.stroke();ctx.restore();
      }
      const g=ctx.createRadialGradient(n.x-NR*.3,n.y-NR*.3,0,n.x,n.y,NR);
      if(isCur){g.addColorStop(0,color);g.addColorStop(1,color+'77');}
      else if(isAdj){g.addColorStop(0,color+'88');g.addColorStop(1,color+'22');}
      else{g.addColorStop(0,'rgba(255,255,255,.16)');g.addColorStop(1,'rgba(255,255,255,.03)');}
      ctx.save();ctx.shadowColor=isCur?color:'rgba(255,255,255,.15)';ctx.shadowBlur=isCur?18:3;
      ctx.beginPath();ctx.arc(n.x,n.y,NR,0,Math.PI*2);
      ctx.fillStyle=g;ctx.fill();
      ctx.strokeStyle=isCur?color:'rgba(255,255,255,.2)';ctx.lineWidth=isCur?2:1.5;ctx.stroke();
      ctx.restore();
      // ã‚¹ã‚¿ãƒ¼ãƒˆæŒ‡ç¤º
      if(cur===null&&pz.endpoints&&pz.endpoints.includes(n.id)){
        ctx.save();ctx.fillStyle='#fff';ctx.globalAlpha=.85;
        ctx.font=`bold ${NR*.6}px Courier New`;
        ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.fillText('S',n.x,n.y);ctx.restore();
      }
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Game {
  constructor(){
    this.cv  = document.getElementById('canvas');
    this.ren = new Renderer(this.cv);
    this.pz  = null;
    this.diff= 2;
    // [FIX-B] ãƒã‚¤ãƒ³ã‚¿ãƒ¼ç®¡ç†ã‚’1å¤‰æ•°ã§å³å¯†ã«
    this._pid      = null;  // è¿½è·¡ä¸­ã® pointerId (null=éè¿½è·¡)
    this._cursor   = null;
    this._lastNode = null;
    this.hover     = null;
    this.hintEids  = null;
    this.hintN     = 0;
    this.timerSec  = 0;
    this._timerID  = null;
    this._busy     = false;
    this._bindAll();
    this.ren.resize();
    this._newPuzzle();
    this._loop();
  }

  _onResize(){
    this.ren.resize();
    if(this.pz)this._relayout();
  }
  _relayout(){
    const{W,H}=this.ren;
    const cx=W/2,cy=H/2,r=Math.min(W,H)*.38;
    const fresh=placeNodes(this.pz.nodes.length,cx,cy,r);
    this.pz.nodes.forEach((n,i)=>{if(fresh[i]){n.x=fresh[i].x;n.y=fresh[i].y;}});
  }

  // [FIX-B] releasePointerCapture ã‚’æ˜ç¤ºçš„ã«å‘¼ã¶
  _release(){
    if(this._pid!==null){
      try{this.cv.releasePointerCapture(this._pid);}catch(_){}
    }
    this._pid=null;this._cursor=null;this._lastNode=null;
  }

  _newPuzzle(){
    if(this._busy)return;
    this._busy=true;
    setTimeout(()=>{this._busy=false;},400);
    this._release(); // captureè§£æ”¾ãŒå…ˆ
    this.hover=null;
    const d=DIFFS[this.diff];
    const{W,H}=this.ren;
    const cx=W/2,cy=H/2,r=Math.min(W,H)*.38;
    const nodes=placeNodes(d.nodes,cx,cy,r);
    const{edges,deg}=buildGraph(d.nodes,d.tri,d.extra);
    this.pz=new Puzzle(nodes,edges,deg,d.color);
    this.hintN=3+d.id;this.hintEids=null;
    this.timerSec=0;this._startTimer();this._ui();
    this._setOverlay(false);
    document.querySelectorAll('.diff-btn').forEach(b=>
      b.classList.toggle('active',+b.dataset.d===this.diff));
  }

  _startTimer(){
    clearInterval(this._timerID);
    document.getElementById('tm').textContent='0:00';
    this._timerID=setInterval(()=>{
      if(!this.pz?.won){
        this.timerSec++;
        const m=0|this.timerSec/60,s=this.timerSec%60;
        document.getElementById('tm').textContent=`${m}:${String(s).padStart(2,'0')}`;
      }
    },1000);
  }
  _ui(){
    document.getElementById('mv').textContent=this.pz?.moves??0;
    document.getElementById('hint-count').textContent=` (${this.hintN})`;
  }
  _setOverlay(show,title='',sub='',stat=''){
    if(show){
      document.getElementById('ov-title').textContent=title;
      document.getElementById('ov-sub').textContent=sub;
      document.getElementById('ov-stat').textContent=stat;
      document.getElementById('overlay').classList.add('show');
    } else {
      document.getElementById('overlay').classList.remove('show');
    }
  }

  // canvasåº§æ¨™å¤‰æ›
  _cvXY(e){
    const r=this.cv.getBoundingClientRect();
    return{x:e.clientX-r.left,y:e.clientY-r.top};
  }
  _nodeAt(x,y){
    if(!this.pz)return null;
    const R=Math.max(this.ren.NR*2.8,44);
    let best=null,bestD=R;
    for(const n of this.pz.nodes){
      const d=hypot(n.x,n.y,x,y);
      if(d<bestD){bestD=d;best=n.id;}
    }
    return best;
  }

  _onPtrDown(e){
    if(this._pid!==null)return; // 2æœ¬ç›®ã®æŒ‡ã¯ç„¡è¦–
    const{x,y}=this._cvXY(e);
    const nid=this._nodeAt(x,y);
    if(nid===null)return;
    e.preventDefault();
    this.cv.setPointerCapture(e.pointerId);
    this._pid=e.pointerId;
    this._cursor={x,y};
    this._lastNode=nid;
    if(this.pz.cur===null){
      if(!this.pz.canStart(nid))return;
      this.pz.start(nid);
    } else {
      this._doMove(nid);
    }
  }
  _onPtrMove(e){
    const{x,y}=this._cvXY(e);
    if(e.pointerId!==this._pid){
      this.hover=this._nodeAt(x,y);return;
    }
    e.preventDefault();
    this._cursor={x,y};
    this.hover=this._nodeAt(x,y);
    const nid=this._nodeAt(x,y);
    if(nid!==null&&nid!==this.pz?.cur&&nid!==this._lastNode){
      this._lastNode=nid;this._doMove(nid);
    }
  }
  _onPtrUp(e){
    if(e.pointerId!==this._pid)return;
    this._pid=null;this._cursor=null;this._lastNode=null;
  }

  _doMove(to){
    if(!this.pz||this.pz.won||to===this.pz.cur)return;
    const r=this.pz.move(to);
    this.hintEids=null;this._ui();
    if(r==='bad'){
      this.cv.classList.remove('shake');
      void this.cv.offsetWidth;
      this.cv.classList.add('shake');
      return;
    }
    if(r==='win'){
      // [FIX-B] ã‚¯ãƒªã‚¢æ™‚ã«å¿…ãšPointerCaptureè§£æ”¾
      this._release();
      clearInterval(this._timerID);
      const d=DIFFS[this.diff];
      const tm=document.getElementById('tm').textContent;
      const burst=()=>this.ren.burst(this.pz.nodes,d.color,12);
      [0,180,360,540,720].forEach(t=>setTimeout(burst,t));
      setTimeout(()=>{
        this._setOverlay(true,'ğŸ‰ ã‚¯ãƒªã‚¢ï¼',`${d.name} â€” ${d.label}`,
          `â± ${tm}  âœ¦  æ‰‹æ•°: ${this.pz.moves}`);
      },650);
    }
    if(r!=='win'&&this.pz.deadEnd()){
      setTimeout(()=>{
        this._setOverlay(true,'âš  è¡Œãè©°ã¾ã‚Š','ãƒªã‚»ãƒƒãƒˆã—ã¦å†æŒ‘æˆ¦ï¼',`æ‰‹æ•°: ${this.pz.moves}`);
      },400);
    }
  }

  _bindAll(){
    // canvas: Pointer Events ã®ã¿ (touch/mouseã‚’äºŒé‡ç™»éŒ²ã—ãªã„)
    this.cv.addEventListener('pointerdown',   e=>this._onPtrDown(e));
    this.cv.addEventListener('pointermove',   e=>this._onPtrMove(e));
    this.cv.addEventListener('pointerup',     e=>this._onPtrUp(e));
    this.cv.addEventListener('pointercancel', e=>this._onPtrUp(e));

    document.querySelectorAll('.diff-btn').forEach(b=>{
      b.addEventListener('click',()=>{this.diff=+b.dataset.d;this._newPuzzle();});
    });
    document.getElementById('btn-undo').addEventListener('click',()=>{
      if(!this.pz||this.pz.won)return;
      if(this.pz.undo()){this.hintEids=null;this._ui();}
    });
    document.getElementById('btn-hint').addEventListener('click',()=>{
      if(!this.pz||this.pz.cur===null||this.hintN<=0||this.hintEids)return;
      const eids=this.pz.freeEdges(this.pz.cur).map(x=>x.eid);
      if(!eids.length)return;
      this.hintN--;this.hintEids=eids;this._ui();
      setTimeout(()=>{this.hintEids=null;},2500);
    });
    document.getElementById('btn-reset').addEventListener('click',()=>{
      if(!this.pz)return;
      this._release();
      this.pz.reset();this.hintEids=null;
      this._setOverlay(false);this._startTimer();this._ui();
    });
    document.getElementById('btn-new').addEventListener('click',()=>this._newPuzzle());
    // [FIX-B] btn-next ã¯ overlayå†…è¦ç´  â†’ canvas ã®PointerCaptureã¨ã¯ç„¡é–¢ä¿‚
    //         releasePointerCaptureæ¸ˆã¿å¾Œã«å‘¼ã°ã‚Œã‚‹ãŸã‚ click ã ã‘ã§ç¢ºå®Ÿã«å‹•ã
    document.getElementById('btn-next').addEventListener('click',()=>this._newPuzzle());
    window.addEventListener('resize',()=>this._onResize());
  }

  _loop(){
    this.ren.draw(this.pz,this.hover,this.hintEids,this._cursor);
    requestAnimationFrame(()=>this._loop());
  }
}

window.addEventListener('DOMContentLoaded',()=>new Game());
</script>
</body>
</html>
